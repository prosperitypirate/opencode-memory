name: opencode-review

on:
  # Auto-review every PR on open / update
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

  # issue_comment / pull_request_review_comment triggers are disabled —
  # the bot lacks write permission to post issue comments
  # issue_comment:
  #   types: [created]
  # pull_request_review_comment:
  #   types: [created]

jobs:
  review:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # Only run on non-draft PRs
    if: github.event.pull_request.draft == false

    permissions:
      id-token: write
      contents: read
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - uses: anomalyco/opencode/github@latest
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          model: anthropic/claude-haiku-4-5
          use_github_token: true
          share: false
          prompt: |
            Review this pull request for the codexfi project (a persistent memory
            plugin for OpenCode using embedded LanceDB + Voyage AI embeddings).

            ## Code quality
            - Correctness and logic bugs
            - TypeScript type safety (plugin/ uses @opencode-ai/plugin SDK)
            - Unused imports, dead code, or accidentally left-in variables
            - Missing error handling or edge cases
            - Consistency with existing patterns in the codebase

            ## Project-specific correctness
            - Memory system: embedding storage, retrieval thresholds, memory type
              taxonomy, session-summary aging rules
            - LanceDB query efficiency and embedding batch sizes
            - Plugin hook correctness (chat.message, event hooks in package.json)

            ## Security
            - Hardcoded secrets, API keys, or tokens in source
            - Injection vulnerabilities, unsafe eval, prototype pollution
            - GitHub Actions supply chain: flag any third-party action using @latest
              or a branch ref (not pinned to a commit SHA) that has sensitive
              permissions (id-token: write, contents: write, or secrets access)

            ## Test coverage
            - Tests live in testing/src/unit/ and testing/src/integration/
            - If the PR adds or changes logic in plugin/src/, flag if no corresponding
              test exists. New exported functions should have unit tests.

            ## Breaking changes
            - Exported TypeScript types or function signatures
            - CLI command names, flags, or output format
            - Plugin hook interface (opencode.type, hooks array in package.json)
            - New or bumped dependencies in package.json

            ## Accessibility (website/ changes only)
            - Missing alt attributes on images
            - Missing ARIA labels on interactive elements
            - Keyboard navigation issues

            ## Documentation
            - Exported functions or types lacking JSDoc
            - README or CHANGELOG updates needed for user-visible changes

            ## PR hygiene
            Flag as Warning if missing:
            - At least one label applied (bug, enhancement, memory-quality, chore, ci,
              backend, frontend, plugin, benchmark, security, documentation, research)
            - A related issue linked (e.g. "Closes #N") — not required for chore/ci/docs PRs
            - PR description is not empty

            Post findings grouped by severity: **Critical**, **Warning**, **Suggestion**.
            Skip empty sections. If the PR looks good, say so briefly.

            IMPORTANT: No preamble about token permissions or environment limitations.
            Post review content directly without any meta-commentary about tooling.
