name: opencode-review

on:
  # Auto-review every PR on open / update
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

  # issue_comment / pull_request_review_comment triggers are disabled —
  # the bot lacks write permission to post issue comments
  # issue_comment:
  #   types: [created]
  # pull_request_review_comment:
  #   types: [created]

jobs:
  review:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # Only run on non-draft PRs
    if: github.event.pull_request.draft == false

    permissions:
      id-token: write      # Required for OpenCode GitHub App token exchange
      contents: read       # Checkout
      pull-requests: write  # Post review comments on PRs
      issues: read         # gh CLI can read issue context for /oc commands

    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - uses: anomalyco/opencode/github@latest
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          model: anthropic/claude-haiku-4-5
          share: false
          prompt: |
            Review this pull request for the opencode-memory project (a self-hosted
            AI coding assistant memory system using LanceDB + Voyage AI embeddings).

            Check for:
            - Correctness and logic bugs
            - TypeScript type safety (plugin/ uses @opencode-ai/plugin SDK)
            - Python async/await correctness and FastAPI patterns (backend/)
            - React/TypeScript component issues (frontend/)
            - Memory system correctness: embedding storage, retrieval thresholds,
              memory type taxonomy, session-summary aging rules
            - Security issues (secrets, injection, auth)
            - Performance concerns (LanceDB query efficiency, embedding batch sizes)
            - Missing error handling or edge cases
            - Consistency with existing patterns in the codebase

            Also check PR hygiene and flag as Warning if any of these are missing:
            - At least one label applied (bug, enhancement, memory-quality, chore, ci, backend, frontend, plugin, benchmark, security, documentation, research)
            - A related issue linked (e.g. "Closes #N") — not required for chore/ci/docs PRs
            - PR description is not empty

            Post a concise review comment on the PR with findings grouped by severity:
            **Critical**, **Warning**, **Suggestion**. Skip sections with no findings.
            If the PR looks good, say so briefly.

            IMPORTANT: Do not include any preamble about GitHub token permissions,
            authentication status, or environment limitations. Post the review
            content directly without any meta-commentary about tooling.
