name: opencode-triage

on:
  issues:
    types: [opened]

jobs:
  # Gate: check account age before allocating a runner for the triage job
  check-account:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      old-enough: ${{ steps.age.outputs.result }}
    permissions:
      contents: none
    steps:
      - name: Check account age (>= 30 days)
        id: age
        uses: actions/github-script@v8
        with:
          script: |
            const user = await github.rest.users.getByUsername({
              username: context.payload.issue.user.login
            });
            const created = new Date(user.data.created_at);
            const days = (Date.now() - created) / (1000 * 60 * 60 * 24);
            return days >= 30;
          result-encoding: string

  triage:
    needs: check-account
    if: needs.check-account.outputs.old-enough == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      id-token: write    # OpenCode GitHub App token exchange
      contents: read
      issues: write      # Post triage comment

    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - uses: anomalyco/opencode/github@latest
        env:
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
        with:
          model: xai/grok-4-1-fast-non-reasoning
          share: false
          prompt: |
            You are triaging a new GitHub issue for the codexfi project.

            ## Project context
            codexfi is a persistent memory plugin for OpenCode (the AI coding agent).
            It embeds LanceDB + Voyage AI embeddings, runs as a TypeScript plugin
            with a CLI and a web dashboard (codexfi.com).

            Key components:
            - plugin/src/           — TypeScript plugin (OpenCode integration, memory store)
            - plugin/src/cli/       — CLI commands (install, status, stats, list, search)
            - website/              — Next.js web dashboard
            - .github/workflows/    — CI/CD

            ## Instructions

            ### Bug reports
            - WITH clear repro steps: read the codebase, identify the likely affected
              file/component, add `bug` label, comment with your finding.
            - WITHOUT repro steps: add `bug` label, ask for OS, Bun/Node version,
              OpenCode version, exact error/stack trace, and steps to reproduce.

            ### Feature requests
            - Add `enhancement` label, acknowledge the request, note the relevant
              component it would touch.

            ### Questions
            - Read the codebase to find an accurate answer. Add `question` label,
              provide a concise answer with file references where relevant.

            ### Duplicates / spam / invalid
            - Search existing open AND closed issues for duplicates first.
            - Duplicate: add `duplicate` label, link the original.
            - Spam or off-topic: add `invalid` label, one sentence explanation.

            ### Ambiguous
            - If none of the above apply, do not comment and do not label.

            ## Tone
            Concise and helpful. One short paragraph per response. Assume good faith.
