name: opencode-scheduled

on:
  workflow_dispatch: # disabled — enable manually if needed
    inputs:
      task:
        description: "What should OpenCode scan or do?"
        required: false
        default: "Run the full weekly scan"

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      id-token: write       # OpenCode GitHub App token exchange
      contents: write       # Create branches / commit fixes
      pull-requests: write  # Open PRs with findings
      issues: write         # Open issues for anything worth tracking

    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - uses: anomalyco/opencode/github@latest
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          model: anthropic/claude-sonnet-4-6
          share: false
          prompt: |
            ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.task != '' && github.event.inputs.task != 'Run the full weekly scan' && format('Manual task requested: {0}\n\nAfter completing this task, also run the weekly scan below.\n\n', github.event.inputs.task) || '' }}Weekly automated scan for the codexfi project.

            Perform the following checks across the entire codebase
            (plugin/, testing/, benchmark/):

            1. **TODOs and FIXMEs** — find all TODO/FIXME/HACK comments. For each,
               assess whether it represents a real gap. Group findings and open a
               single GitHub issue summarising them if there are 3 or more.

            2. **Security smells** — look for hardcoded secrets, unvalidated inputs,
               missing auth checks, or dangerous patterns in the TypeScript plugin
               and CLI commands.

            3. **Dead code** — identify exported functions, API routes, or components
               that appear unused. List them as suggestions, not blockers.

            4. **Dependency drift** — check package.json (plugin/, testing/, benchmark/)
               for obviously outdated or insecure packages.
               Open an issue if you find anything critical.

            5. **Memory system health** — review the LanceDB schema, embedding
               pipeline, and memory aging logic for correctness against the intended
               design: typed taxonomy, relational versioning (superseded_by),
               session-summary capping at 3, progress keeping only latest.

            For each category:
            - If nothing to report: skip it silently.
            - If minor findings: include them in a single summary issue titled
              "Weekly scan – [date]" with findings grouped by category.
            - If a finding is critical (security, data corruption): open a separate
              issue immediately and label it `security` or `bug`.

            Do not open more than 3 issues total per run. Prefer one consolidated
            summary over many small issues.
